<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta httpEquiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no" />
  <title>Карта и чат для постов ДПС в реальном времени в Кингисеппе</title>
  
  <!-- Content Security Policy -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval' 
      https://telegram.org 
      https://api.mapbox.com 
      https://cdn.jsdelivr.net 
      https://unpkg.com 
      https://*.telegram.org
      https://*.telegram.me
      blob: data: *;
    script-src-elem 'self' 'unsafe-inline' 
      https://telegram.org 
      https://api.mapbox.com 
      https://cdn.jsdelivr.net 
      https://unpkg.com 
      https://*.telegram.org
      https://*.telegram.me
      blob: data: *;
    style-src 'self' 'unsafe-inline' 
      https://api.mapbox.com 
      https://fonts.googleapis.com
      https://*.telegram.org
      *;
    font-src 'self' 
      https://fonts.gstatic.com 
      https://*.telegram.org
      data: *;
    img-src 'self' 
      https: 
      data: 
      blob: *;
    connect-src 'self' 
      https://api.mapbox.com 
      https://events.mapbox.com 
      https://*.telegram.org
      https://*.telegram.me
      wss: 
      ws: *;
    worker-src 'self' 
      blob: *;
    child-src 'self' 
      blob: *;
    media-src 'self' 
      https: 
      blob: 
      data: *;
  ">
  
  <!-- Telegram WebApp Script -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- Telegram WebApp Meta Tags -->
  <meta name="telegram-web-app" content="true">
  <meta name="telegram-web-app-version" content="1.0">
  <meta name="telegram-web-app-platform" content="web">
  
  <!-- PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="ДПС Кингисепп">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#007AFF">
  
  <!-- Prevent external navigation -->
  <meta name="referrer" content="no-referrer">
  <meta name="robots" content="noindex, nofollow">
  
  <!-- Cache busting -->
  <meta name="cache-control" content="no-cache, no-store, must-revalidate">
  <meta name="pragma" content="no-cache">
  <meta name="expires" content="0">
  <meta name="version" content="1.0.1-2025-01-22-09-35">
  
  <style>
    :root {
      --tg-viewport-height: 100vh;
      --tg-theme-bg-color: #ffffff;
      --tg-theme-text-color: #000000;
      --tg-theme-hint-color: #999999;
      --tg-theme-link-color: #007AFF;
      --tg-theme-button-color: #007AFF;
      --tg-theme-button-text-color: #ffffff;
      --tg-theme-secondary-bg-color: #f2f2f7;
    }
    
    html, body {
      height: 100%;
      height: var(--tg-viewport-height, 100vh);
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'SF Pro Display', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow: hidden;
      position: fixed;
      width: 100%;
      top: 0;
      left: 0;
    }
    
    #root {
      height: 100%;
      height: var(--tg-viewport-height, 100vh);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    /* Telegram WebApp specific styles */
    body {
      background-color: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
    }
    
    /* Disable text selection and context menu for better app feel */
    * {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    /* Allow text selection for inputs and text areas */
    input, textarea, [contenteditable] {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }
    
    /* Loading screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--tg-theme-bg-color);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--tg-theme-hint-color);
      border-top: 3px solid var(--tg-theme-button-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="loading" class="loading-screen">
    <div class="loading-spinner"></div>
  </div>
  <div id="root"></div>
  
  <script>
    // Initialize Telegram WebApp
    let telegramWebApp = null;
    
    if (window.Telegram && window.Telegram.WebApp) {
      telegramWebApp = window.Telegram.WebApp;
      
      // Apply Telegram theme
      if (telegramWebApp.themeParams) {
        const root = document.documentElement;
        Object.keys(telegramWebApp.themeParams).forEach(key => {
          const cssVar = `--tg-theme-${key.replace(/_/g, '-')}`;
          root.style.setProperty(cssVar, telegramWebApp.themeParams[key]);
        });
      }
      
      // Set viewport height for mobile
      if (telegramWebApp.viewportHeight) {
        document.documentElement.style.setProperty('--tg-viewport-height', telegramWebApp.viewportHeight + 'px');
      }
      
      // Handle viewport changes
      telegramWebApp.onEvent('viewportChanged', function() {
        if (telegramWebApp.viewportHeight) {
          document.documentElement.style.setProperty('--tg-viewport-height', telegramWebApp.viewportHeight + 'px');
        }
      });
      
      // Handle theme changes
      telegramWebApp.onEvent('themeChanged', function() {
        if (telegramWebApp.themeParams) {
          const root = document.documentElement;
          Object.keys(telegramWebApp.themeParams).forEach(key => {
            const cssVar = `--tg-theme-${key.replace(/_/g, '-')}`;
            root.style.setProperty(cssVar, telegramWebApp.themeParams[key]);
          });
        }
      });
      
      console.log('Telegram WebApp инициализирован:', {
        version: telegramWebApp.version,
        platform: telegramWebApp.platform,
        colorScheme: telegramWebApp.colorScheme,
        themeParams: telegramWebApp.themeParams,
        initDataUnsafe: telegramWebApp.initDataUnsafe,
        viewportHeight: telegramWebApp.viewportHeight
      });
      
      // Готовим WebApp
      telegramWebApp.ready();
      
      // Расширяем на весь экран
      telegramWebApp.expand();
      
      // Отключаем подтверждение закрытия для плавной работы
      telegramWebApp.isClosingConfirmationEnabled = false;
      
      // Включаем тактильную обратную связь
      if (telegramWebApp.HapticFeedback) {
        telegramWebApp.HapticFeedback.impactOccurred('light');
      }
      
      // Скрываем главную кнопку по умолчанию
      if (telegramWebApp.MainButton) {
        telegramWebApp.MainButton.hide();
      }
      
      // Скрываем кнопку назад по умолчанию
      if (telegramWebApp.BackButton) {
        telegramWebApp.BackButton.hide();
      }
      
    } else {
      console.log('Не запущено в Telegram WebApp окружении');
    }
    
    // Hide loading screen when app is ready
    window.addEventListener('load', function() {
      setTimeout(function() {
        const loading = document.getElementById('loading');
        if (loading) {
          loading.style.opacity = '0';
          loading.style.transition = 'opacity 0.3s ease';
          setTimeout(function() {
            loading.style.display = 'none';
          }, 300);
        }
      }, 1000);
    });
    
    // Prevent zoom on double tap
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
    
    // Prevent context menu
    document.addEventListener('contextmenu', function(e) {
      e.preventDefault();
    });
    
    // Global error handling for Telegram API errors
    window.addEventListener('error', function(event) {
      // Ignore Telegram FILE_REFERENCE_EXPIRED errors
      if (event.error && event.error.message && event.error.message.includes('FILE_REFERENCE_EXPIRED')) {
        console.warn('⚠️ Ignoring Telegram FILE_REFERENCE_EXPIRED error');
        event.preventDefault();
        return false;
      }
      
      // Ignore Telegram RPC errors
      if (event.error && event.error.message && event.error.message.includes('RPCError')) {
        console.warn('⚠️ Ignoring Telegram RPC error:', event.error.message);
        event.preventDefault();
        return false;
      }
      
      // Ignore Content Security Policy violations for known safe sources
      if (event.message && event.message.includes('Content Security Policy')) {
        console.warn('⚠️ CSP violation (may be expected):', event.message);
        return false;
      }
    });
    
    // Handle unhandled promise rejections
    window.addEventListener('unhandledrejection', function(event) {
      // Ignore Telegram API promise rejections
      if (event.reason && event.reason.message) {
        if (event.reason.message.includes('FILE_REFERENCE_EXPIRED') || 
            event.reason.message.includes('RPCError')) {
          console.warn('⚠️ Ignoring Telegram promise rejection:', event.reason.message);
          event.preventDefault();
          return false;
        }
      }
    });
  </script>
</body>
</html>