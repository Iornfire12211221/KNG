__d((function(g,r,i,a,m,e,d){Object.defineProperty(e,"__esModule",{value:!0}),e.EnhancedAIModeration=void 0;var t=r(d[0]);class n{static API_URL='https://toolkit.rork.com/text/llm/';static CACHE_TTL=3e5;static cache=new Map;static async moderatePost(t){const n=Date.now();try{const o=this.generateCacheKey(t),c=this.getFromCache(o);if(c)return console.log("\ud83c\udfaf Cache hit for post moderation"),c;const s=await this.useNewSmartAI(t);this.setCache(o,s),await this.saveModerationResult(t,s);const l=Date.now()-n;return s.processingTime=l,console.log(`\ud83e\udde0 NEW SMART AI moderated: ${s.decision} (${l}ms, confidence: ${s.confidence})`),s}catch(n){console.error('\u274c NEW SMART AI moderation error:',n);return await this.performMultiLevelAnalysis(t)}}static async performMultiLevelAnalysis(t){const n=await this.checkToxicity(t.description);if(n.toxicityScore>.8)return{decision:'REJECTED',confidence:.9,reasoning:'\u0412\u044b\u0441\u043e\u043a\u0438\u0439 \u0443\u0440\u043e\u0432\u0435\u043d\u044c \u0442\u043e\u043a\u0441\u0438\u0447\u043d\u043e\u0441\u0442\u0438 \u043a\u043e\u043d\u0442\u0435\u043d\u0442\u0430',toxicityScore:n.toxicityScore,relevanceScore:.1,severityScore:.1,categoryScore:.1,detectedLanguage:n.language,keyPhrases:n.keyPhrases,entities:[]};const o=await this.checkRelevance(t);if(o.relevanceScore<.3)return{decision:'REJECTED',confidence:.8,reasoning:'\u041a\u043e\u043d\u0442\u0435\u043d\u0442 \u043d\u0435 \u043e\u0442\u043d\u043e\u0441\u0438\u0442\u0441\u044f \u043a \u0434\u043e\u0440\u043e\u0436\u043d\u044b\u043c \u043f\u0440\u043e\u0438\u0441\u0448\u0435\u0441\u0442\u0432\u0438\u044f\u043c',toxicityScore:n.toxicityScore,relevanceScore:o.relevanceScore,severityScore:.1,categoryScore:.1,detectedLanguage:n.language,keyPhrases:[...n.keyPhrases,...o.keyPhrases],entities:o.entities};let c=null;if(t.hasPhoto&&t.photo&&(c=await this.analyzeImage(t.photo,t.type,t.description),c&&c.relevanceScore<.2))return{decision:'REJECTED',confidence:.9,reasoning:'\u0418\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u0435 \u043d\u0435 \u0441\u043e\u043e\u0442\u0432\u0435\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0434\u043e\u0440\u043e\u0436\u043d\u043e\u0439 \u0442\u0435\u043c\u0430\u0442\u0438\u043a\u0435',toxicityScore:n.toxicityScore,relevanceScore:c.relevanceScore,severityScore:.1,categoryScore:.1,detectedLanguage:n.language,keyPhrases:[...n.keyPhrases,...o.keyPhrases],entities:o.entities};const s=await this.performDetailedAnalysis(t),l=this.makeDecision({toxicity:n.toxicityScore,relevance:o.relevanceScore,severity:s.severityScore,category:s.categoryScore,imageRelevance:c?.relevanceScore||1});return{decision:l.decision,confidence:l.confidence,reasoning:l.reasoning,toxicityScore:n.toxicityScore,relevanceScore:o.relevanceScore,severityScore:s.severityScore,categoryScore:s.categoryScore,detectedLanguage:n.language,keyPhrases:[...n.keyPhrases,...o.keyPhrases,...s.keyPhrases],entities:[...o.entities,...s.entities]}}static async checkToxicity(t){const n=`\n\u041f\u0440\u043e\u0430\u043d\u0430\u043b\u0438\u0437\u0438\u0440\u0443\u0439 \u0442\u0435\u043a\u0441\u0442 \u043d\u0430 \u0442\u043e\u043a\u0441\u0438\u0447\u043d\u043e\u0441\u0442\u044c \u0438 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0438 \u044f\u0437\u044b\u043a:\n\n\u0422\u0435\u043a\u0441\u0442: "${t}"\n\n\u041e\u0446\u0435\u043d\u0438:\n1. \u0422\u043e\u043a\u0441\u0438\u0447\u043d\u043e\u0441\u0442\u044c (0-1): \u043e\u0441\u043a\u043e\u0440\u0431\u043b\u0435\u043d\u0438\u044f, \u0443\u0433\u0440\u043e\u0437\u044b, \u0440\u0430\u0437\u0436\u0438\u0433\u0430\u043d\u0438\u0435 \u043d\u0435\u043d\u0430\u0432\u0438\u0441\u0442\u0438\n2. \u042f\u0437\u044b\u043a: ru/en/other\n3. \u041a\u043b\u044e\u0447\u0435\u0432\u044b\u0435 \u0444\u0440\u0430\u0437\u044b: \u0432\u044b\u0434\u0435\u043b\u0438 \u043e\u0441\u043d\u043e\u0432\u043d\u044b\u0435 \u0441\u043b\u043e\u0432\u0430/\u0444\u0440\u0430\u0437\u044b\n\n\u041e\u0442\u0432\u0435\u0442 \u0432 JSON:\n{\n  "toxicityScore": \u0447\u0438\u0441\u043b\u043e \u043e\u0442 0 \u0434\u043e 1,\n  "language": "ru",\n  "keyPhrases": ["\u0444\u0440\u0430\u0437\u04301", "\u0444\u0440\u0430\u0437\u04302"]\n}\n\n\u041f\u0440\u0430\u0432\u0438\u043b\u0430:\n- 0.0-0.3: \u041d\u0438\u0437\u043a\u0430\u044f \u0442\u043e\u043a\u0441\u0438\u0447\u043d\u043e\u0441\u0442\u044c\n- 0.3-0.7: \u0421\u0440\u0435\u0434\u043d\u044f\u044f \u0442\u043e\u043a\u0441\u0438\u0447\u043d\u043e\u0441\u0442\u044c  \n- 0.7-1.0: \u0412\u044b\u0441\u043e\u043a\u0430\u044f \u0442\u043e\u043a\u0441\u0438\u0447\u043d\u043e\u0441\u0442\u044c\n`,o=await this.callAI(n);return JSON.parse(o)}static async checkRelevance(t){const n=`\n\u041f\u0440\u043e\u0430\u043d\u0430\u043b\u0438\u0437\u0438\u0440\u0443\u0439, \u043d\u0430\u0441\u043a\u043e\u043b\u044c\u043a\u043e \u043f\u043e\u0441\u0442 \u043e\u0442\u043d\u043e\u0441\u0438\u0442\u0441\u044f \u043a \u0434\u043e\u0440\u043e\u0436\u043d\u044b\u043c \u043f\u0440\u043e\u0438\u0441\u0448\u0435\u0441\u0442\u0432\u0438\u044f\u043c \u0432 \u041a\u0438\u043d\u0433\u0438\u0441\u0435\u043f\u043f\u0435:\n\n\u0422\u0438\u043f: ${t.type}\n\u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435: ${t.description}\n\u0421\u0435\u0440\u044c\u0435\u0437\u043d\u043e\u0441\u0442\u044c: ${t.severity}\n\u0424\u043e\u0442\u043e: ${t.hasPhoto?'\u0414\u0430':'\u041d\u0435\u0442'}\n\u041c\u0435\u0441\u0442\u043e\u043f\u043e\u043b\u043e\u0436\u0435\u043d\u0438\u0435: ${t.location||'\u041d\u0435 \u0443\u043a\u0430\u0437\u0430\u043d\u043e'}\n\n\u041e\u0446\u0435\u043d\u0438 \u0440\u0435\u043b\u0435\u0432\u0430\u043d\u0442\u043d\u043e\u0441\u0442\u044c (0-1) \u0438 \u0432\u044b\u0434\u0435\u043b\u0438:\n1. \u041a\u043b\u044e\u0447\u0435\u0432\u044b\u0435 \u0444\u0440\u0430\u0437\u044b \u043e \u0434\u043e\u0440\u043e\u0433\u0435/\u0442\u0440\u0430\u043d\u0441\u043f\u043e\u0440\u0442\u0435\n2. \u0421\u0443\u0449\u043d\u043e\u0441\u0442\u0438: \u043c\u0435\u0441\u0442\u0430, \u0441\u043e\u0431\u044b\u0442\u0438\u044f, \u043e\u0431\u044a\u0435\u043a\u0442\u044b\n\n\u041e\u0442\u0432\u0435\u0442 \u0432 JSON:\n{\n  "relevanceScore": \u0447\u0438\u0441\u043b\u043e \u043e\u0442 0 \u0434\u043e 1,\n  "keyPhrases": ["\u0444\u0440\u0430\u0437\u04301", "\u0444\u0440\u0430\u0437\u04302"],\n  "entities": ["\u043c\u0435\u0441\u0442\u043e1", "\u0441\u043e\u0431\u044b\u0442\u0438\u04351"]\n}\n\n\u0420\u0435\u043b\u0435\u0432\u0430\u043d\u0442\u043d\u044b\u0435 \u0442\u0435\u043c\u044b:\n- \u0414\u041f\u0421, \u043f\u043e\u043b\u0438\u0446\u0438\u044f, \u043f\u0430\u0442\u0440\u0443\u043b\u044c\n- \u0414\u0422\u041f, \u0430\u0432\u0430\u0440\u0438\u0438, \u0441\u0442\u043e\u043b\u043a\u043d\u043e\u0432\u0435\u043d\u0438\u044f\n- \u041a\u0430\u043c\u0435\u0440\u044b, \u0440\u0430\u0434\u0430\u0440\u044b, \u043a\u043e\u043d\u0442\u0440\u043e\u043b\u044c \u0441\u043a\u043e\u0440\u043e\u0441\u0442\u0438\n- \u0414\u043e\u0440\u043e\u0436\u043d\u044b\u0435 \u0440\u0430\u0431\u043e\u0442\u044b, \u0440\u0435\u043c\u043e\u043d\u0442\n- \u041f\u0440\u043e\u0431\u043a\u0438, \u0437\u0430\u0442\u043e\u0440\u044b\n- \u0416\u0438\u0432\u043e\u0442\u043d\u044b\u0435 \u043d\u0430 \u0434\u043e\u0440\u043e\u0433\u0435\n- \u041f\u043e\u0433\u043e\u0434\u043d\u044b\u0435 \u0443\u0441\u043b\u043e\u0432\u0438\u044f\n- \u0417\u043d\u0430\u043a\u0438, \u0441\u0432\u0435\u0442\u043e\u0444\u043e\u0440\u044b\n`,o=await this.callAI(n);return JSON.parse(o)}static async performDetailedAnalysis(t){const n=`\n\u041f\u0440\u043e\u0430\u043d\u0430\u043b\u0438\u0437\u0438\u0440\u0443\u0439 \u0441\u0435\u0440\u044c\u0435\u0437\u043d\u043e\u0441\u0442\u044c \u0438 \u0442\u043e\u0447\u043d\u043e\u0441\u0442\u044c \u043a\u0430\u0442\u0435\u0433\u043e\u0440\u0438\u0437\u0430\u0446\u0438\u0438:\n\n\u0422\u0438\u043f: ${t.type}\n\u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435: ${t.description}\n\u0421\u0435\u0440\u044c\u0435\u0437\u043d\u043e\u0441\u0442\u044c: ${t.severity}\n\n\u041e\u0446\u0435\u043d\u0438:\n1. \u0421\u0435\u0440\u044c\u0435\u0437\u043d\u043e\u0441\u0442\u044c (0-1): \u043d\u0430\u0441\u043a\u043e\u043b\u044c\u043a\u043e \u043a\u0440\u0438\u0442\u0438\u0447\u043d\u043e \u043f\u0440\u043e\u0438\u0441\u0448\u0435\u0441\u0442\u0432\u0438\u0435\n2. \u041a\u0430\u0442\u0435\u0433\u043e\u0440\u0438\u0437\u0430\u0446\u0438\u044f (0-1): \u043d\u0430\u0441\u043a\u043e\u043b\u044c\u043a\u043e \u0442\u043e\u0447\u043d\u043e \u0432\u044b\u0431\u0440\u0430\u043d \u0442\u0438\u043f\n3. \u0414\u043e\u043f\u043e\u043b\u043d\u0438\u0442\u0435\u043b\u044c\u043d\u044b\u0435 \u043a\u043b\u044e\u0447\u0435\u0432\u044b\u0435 \u0444\u0440\u0430\u0437\u044b\n4. \u0414\u043e\u043f\u043e\u043b\u043d\u0438\u0442\u0435\u043b\u044c\u043d\u044b\u0435 \u0441\u0443\u0449\u043d\u043e\u0441\u0442\u0438\n\n\u041e\u0442\u0432\u0435\u0442 \u0432 JSON:\n{\n  "severityScore": \u0447\u0438\u0441\u043b\u043e \u043e\u0442 0 \u0434\u043e 1,\n  "categoryScore": \u0447\u0438\u0441\u043b\u043e \u043e\u0442 0 \u0434\u043e 1,\n  "keyPhrases": ["\u0444\u0440\u0430\u0437\u04301", "\u0444\u0440\u0430\u0437\u04302"],\n  "entities": ["\u0441\u0443\u0449\u043d\u043e\u0441\u0442\u044c1", "\u0441\u0443\u0449\u043d\u043e\u0441\u0442\u044c2"]\n}\n\n\u041a\u0440\u0438\u0442\u0435\u0440\u0438\u0438 \u0441\u0435\u0440\u044c\u0435\u0437\u043d\u043e\u0441\u0442\u0438:\n- 0.0-0.3: \u041d\u0438\u0437\u043a\u0430\u044f (\u043e\u0431\u044b\u0447\u043d\u044b\u0435 \u043f\u043e\u0441\u0442\u044b \u0414\u041f\u0421, \u043a\u0430\u043c\u0435\u0440\u044b)\n- 0.3-0.7: \u0421\u0440\u0435\u0434\u043d\u044f\u044f (\u043f\u0440\u043e\u0431\u043a\u0438, \u0440\u0435\u043c\u043e\u043d\u0442 \u0434\u043e\u0440\u043e\u0433)\n- 0.7-1.0: \u0412\u044b\u0441\u043e\u043a\u0430\u044f (\u0414\u0422\u041f, \u044d\u043a\u0441\u0442\u0440\u0435\u043d\u043d\u044b\u0435 \u0441\u0438\u0442\u0443\u0430\u0446\u0438\u0438)\n`,o=await this.callAI(n);return JSON.parse(o)}static makeDecision(t){if(t.toxicity>.7)return{decision:'REJECTED',confidence:.9,reasoning:'\u0421\u043e\u0434\u0435\u0440\u0436\u0438\u0442 \u0442\u043e\u043a\u0441\u0438\u0447\u043d\u044b\u0439 \u043a\u043e\u043d\u0442\u0435\u043d\u0442'};if(t.relevance<.3)return{decision:'REJECTED',confidence:.8,reasoning:'\u041d\u0435 \u043e\u0442\u043d\u043e\u0441\u0438\u0442\u0441\u044f \u043a \u0434\u043e\u0440\u043e\u0436\u043d\u044b\u043c \u043f\u0440\u043e\u0438\u0441\u0448\u0435\u0441\u0442\u0432\u0438\u044f\u043c'};const n=t.imageRelevance||1,o=(t.relevance+n)/2;if(o>.7&&t.toxicity<.3){let n='\u041a\u0430\u0447\u0435\u0441\u0442\u0432\u0435\u043d\u043d\u044b\u0439 \u043a\u043e\u043d\u0442\u0435\u043d\u0442 \u043e \u0434\u043e\u0440\u043e\u0436\u043d\u043e\u0439 \u0441\u0438\u0442\u0443\u0430\u0446\u0438\u0438';return t.imageRelevance&&t.imageRelevance<.8&&(n+=' (\u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u0435 \u0442\u0440\u0435\u0431\u0443\u0435\u0442 \u043f\u0440\u043e\u0432\u0435\u0440\u043a\u0438)'),{decision:'APPROVED',confidence:.9,reasoning:n}}return t.imageRelevance&&t.imageRelevance<.3?{decision:'REJECTED',confidence:.8,reasoning:'\u0418\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u0435 \u043d\u0435 \u0441\u043e\u043e\u0442\u0432\u0435\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0434\u043e\u0440\u043e\u0436\u043d\u043e\u0439 \u0442\u0435\u043c\u0430\u0442\u0438\u043a\u0435'}:o>.5&&t.toxicity<.5?{decision:'FLAGGED',confidence:.6,reasoning:'\u0422\u0440\u0435\u0431\u0443\u0435\u0442 \u0440\u0443\u0447\u043d\u043e\u0439 \u043f\u0440\u043e\u0432\u0435\u0440\u043a\u0438 \u043c\u043e\u0434\u0435\u0440\u0430\u0442\u043e\u0440\u0430'}:{decision:'FLAGGED',confidence:.5,reasoning:'\u041d\u0435\u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u043d\u044b\u0439 \u0441\u043b\u0443\u0447\u0430\u0439, \u0442\u0440\u0435\u0431\u0443\u0435\u0442 \u043f\u0440\u043e\u0432\u0435\u0440\u043a\u0438'}}static fallbackModeration(t){const n=t.description.toLowerCase(),o=['\u0434\u0442\u043f','\u0430\u0432\u0430\u0440\u0438\u044f','\u043f\u0440\u043e\u0431\u043a\u0430','\u0434\u043f\u0441','\u043f\u043e\u043b\u0438\u0446\u0438\u044f','\u043a\u0430\u043c\u0435\u0440\u0430','\u0434\u043e\u0440\u043e\u0433\u0430','\u043c\u0430\u0448\u0438\u043d\u0430','\u0430\u0432\u0442\u043e\u043c\u043e\u0431\u0438\u043b\u044c','\u0441\u0432\u0435\u0442\u043e\u0444\u043e\u0440','\u043f\u0435\u0440\u0435\u043a\u0440\u0435\u0441\u0442\u043e\u043a','\u043f\u0430\u0442\u0440\u0443\u043b\u044c','\u0440\u0435\u043c\u043e\u043d\u0442','\u0440\u0430\u0431\u043e\u0442\u0430','\u0436\u0438\u0432\u043e\u0442\u043d\u044b\u0435','\u0441\u043d\u0435\u0433','\u0434\u043e\u0436\u0434\u044c','\u0442\u0443\u043c\u0430\u043d'].some((t=>n.includes(t)))?.8:.3,c=['\u0431\u043b\u044f\u0442\u044c','\u0441\u0443\u043a\u0430','\u0445\u0443\u0439','\u043f\u0438\u0437\u0434\u0430','\u0435\u0431\u0430\u0442\u044c','\u0441\u043f\u0430\u043c','\u0440\u0435\u043a\u043b\u0430\u043c\u0430'].some((t=>n.includes(t)))?.9:.1;let s='FLAGGED';return o>.7&&c<.3?s='APPROVED':(c>.7||o<.3)&&(s='REJECTED'),{decision:s,confidence:.6,reasoning:'Fallback moderation based on keyword analysis',toxicityScore:c,relevanceScore:o,severityScore:['\u043a\u0440\u0438\u0442\u0438\u0447\u043d\u043e','\u0441\u0440\u043e\u0447\u043d\u043e','\u0441\u043a\u043e\u0440\u0430\u044f','\u043f\u043e\u0436\u0430\u0440','\u0440\u0430\u043d\u0435\u043d','\u0443\u0431\u0438\u0442'].some((t=>n.includes(t)))?.9:.5,categoryScore:.7,detectedLanguage:'ru',keyPhrases:[],entities:[]}}static async callAI(t){try{const n=await fetch(this.API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[{role:'system',content:'\u0422\u044b \u044d\u043a\u0441\u043f\u0435\u0440\u0442 \u043f\u043e \u043c\u043e\u0434\u0435\u0440\u0430\u0446\u0438\u0438 \u043a\u043e\u043d\u0442\u0435\u043d\u0442\u0430 \u0434\u043e\u0440\u043e\u0436\u043d\u044b\u0445 \u043f\u0440\u043e\u0438\u0441\u0448\u0435\u0441\u0442\u0432\u0438\u0439 \u0432 \u041a\u0438\u043d\u0433\u0438\u0441\u0435\u043f\u043f\u0435. \u041e\u0442\u0432\u0435\u0447\u0430\u0439 \u0442\u043e\u043b\u044c\u043a\u043e \u0432 \u0444\u043e\u0440\u043c\u0430\u0442\u0435 JSON \u0431\u0435\u0437 \u0434\u043e\u043f\u043e\u043b\u043d\u0438\u0442\u0435\u043b\u044c\u043d\u043e\u0433\u043e \u0442\u0435\u043a\u0441\u0442\u0430.'},{role:'user',content:t}]})});if(!n.ok)throw new Error(`AI API error: ${n.status}`);const o=await n.json();let c=o.completion||o.content||o.message||'';c=c.trim(),c.startsWith('```json')?c=c.replace(/```json\s*/,'').replace(/```\s*$/,''):c.startsWith('```')&&(c=c.replace(/```\s*/,'').replace(/```\s*$/,'')),c=c.replace(/^[^{]*/,'').replace(/[^}]*$/,'');const s=c.match(/\{[\s\S]*\}/);s&&(c=s[0]);try{return JSON.parse(c),c}catch(t){return console.warn('AI returned invalid JSON, using fallback:',c),JSON.stringify({toxicityScore:.1,language:'ru',isRelevant:!0,relevanceScore:.8,severityScore:.5,categoryScore:.7,keyPhrases:[],entities:[]})}}catch(t){throw console.error('AI API call failed:',t),t}}static async saveModerationResult(n,o){try{const c=await t.prisma.post.findFirst({where:{description:n.description,type:n.type},orderBy:{createdAt:'desc'}});c&&(await t.prisma.post.update({where:{id:c.id},data:{moderationStatus:o.decision,moderationScore:o.confidence,moderationReason:o.reasoning,moderatedAt:BigInt(Date.now()),moderatedBy:'AI',needsModeration:'FLAGGED'===o.decision,relevanceScore:o.relevanceScore,relevanceCheckedAt:BigInt(Date.now())}}),await t.prisma.aIModeration.create({data:{postId:c.id,content:n.description,toxicityScore:o.toxicityScore,relevanceScore:o.relevanceScore,severityScore:o.severityScore,categoryScore:o.categoryScore,detectedLanguage:o.detectedLanguage,keyPhrases:o.keyPhrases||[],entities:o.entities||[],decision:o.decision,confidence:o.confidence,reasoning:o.reasoning}}))}catch(t){console.error('Error saving moderation result:',t)}}static generateCacheKey(t){return`${t.type}_${t.description.substring(0,50)}_${t.severity}`}static getFromCache(t){const n=this.cache.get(t);return n?Date.now()-n.timestamp>this.CACHE_TTL?(this.cache.delete(t),null):n.result:null}static setCache(t,n){this.cache.set(t,{result:n,timestamp:Date.now()})}static async getModerationStats(){try{const n=await t.prisma.aIModeration.groupBy({by:['decision'],_count:{decision:!0},_avg:{confidence:!0,toxicityScore:!0,relevanceScore:!0}});return{total:await t.prisma.aIModeration.count(),byDecision:n.reduce(((t,n)=>(t[n.decision]={count:n._count.decision,avgConfidence:n._avg.confidence||0,avgToxicity:n._avg.toxicityScore||0,avgRelevance:n._avg.relevanceScore||0},t)),{})}}catch(t){throw console.error('Error getting moderation stats:',t),t}}static async moderatePendingPosts(){try{const n=await t.prisma.post.findMany({where:{moderationStatus:'PENDING',needsModeration:!0},take:10});console.log(`\ud83e\udd16 Starting AI moderation for ${n.length} posts`);for(const t of n)try{const n={type:t.type,description:t.description,severity:t.severity,hasPhoto:!!t.photo,photo:t.photo||void 0,location:t.address||t.landmark};await this.moderatePost(n);await new Promise((t=>setTimeout(t,500)))}catch(n){console.error(`Error moderating post ${t.id}:`,n)}console.log("\u2705 AI moderation batch completed")}catch(t){throw console.error('Error in batch moderation:',t),t}}static async analyzeImage(t,n,o){try{console.log('\ud83d\uddbc\ufe0f Analyzing image for post type:',n);const c=new Date,s=c.getHours(),l=c.getMinutes(),h=c.toLocaleDateString('ru-RU'),y=`${s.toString().padStart(2,'0')}:${l.toString().padStart(2,'0')}`;let p;p=s>=6&&s<12?'\u0443\u0442\u0440\u043e':s>=12&&s<18?'\u0434\u0435\u043d\u044c':s>=18&&s<22?'\u0432\u0435\u0447\u0435\u0440':'\u043d\u043e\u0447\u044c';const S=c.getMonth()+1;let u;u=S>=3&&S<=5?'\u0432\u0435\u0441\u043d\u0430':S>=6&&S<=8?'\u043b\u0435\u0442\u043e':S>=9&&S<=11?'\u043e\u0441\u0435\u043d\u044c':'\u0437\u0438\u043c\u0430';const v=(t=>{switch(t){case'roadwork':return{name:'\u0414\u043e\u0440\u043e\u0436\u043d\u044b\u0435 \u0440\u0430\u0431\u043e\u0442\u044b',expected:'\u0434\u043e\u0440\u043e\u0436\u043d\u0430\u044f \u0442\u0435\u0445\u043d\u0438\u043a\u0430 (\u044d\u043a\u0441\u043a\u0430\u0432\u0430\u0442\u043e\u0440\u044b, \u0430\u0441\u0444\u0430\u043b\u044c\u0442\u043e\u0443\u043a\u043b\u0430\u0434\u0447\u0438\u043a\u0438, \u043a\u0430\u0442\u043a\u0438, \u0433\u0440\u0443\u0437\u043e\u0432\u0438\u043a\u0438, \u043a\u0440\u0430\u043d\u044b), \u0440\u0430\u0431\u043e\u0447\u0438\u0435 \u0432 \u0441\u043f\u0435\u0446\u043e\u0434\u0435\u0436\u0434\u0435, \u043e\u0433\u0440\u0430\u0436\u0434\u0435\u043d\u0438\u044f, \u043a\u043e\u043d\u0443\u0441\u044b, \u0437\u043d\u0430\u043a\u0438 "\u0414\u043e\u0440\u043e\u0436\u043d\u044b\u0435 \u0440\u0430\u0431\u043e\u0442\u044b", \u0441\u0432\u0435\u0436\u0438\u0439 \u0430\u0441\u0444\u0430\u043b\u044c\u0442, \u0440\u0435\u043c\u043e\u043d\u0442 \u0434\u043e\u0440\u043e\u0436\u043d\u043e\u0433\u043e \u043f\u043e\u043a\u0440\u044b\u0442\u0438\u044f, \u0441\u0442\u0440\u043e\u0438\u0442\u0435\u043b\u044c\u043d\u044b\u0435 \u043c\u0430\u0442\u0435\u0440\u0438\u0430\u043b\u044b, \u0436\u0435\u043b\u0442\u0430\u044f \u0441\u043f\u0435\u0446\u0442\u0435\u0445\u043d\u0438\u043a\u0430'};case'other':return{name:'\u041e\u0441\u0442\u0430\u043b\u044c\u043d\u043e\u0435 (\u043f\u0440\u043e\u0431\u043b\u0435\u043c\u044b \u0438\u043d\u0444\u0440\u0430\u0441\u0442\u0440\u0443\u043a\u0442\u0443\u0440\u044b)',expected:'\u044f\u043c\u044b \u043d\u0430 \u0434\u043e\u0440\u043e\u0433\u0435, \u043f\u043e\u0432\u0440\u0435\u0436\u0434\u0435\u043d\u043d\u043e\u0435 \u043f\u043e\u043a\u0440\u044b\u0442\u0438\u0435, \u0441\u043b\u043e\u043c\u0430\u043d\u043d\u044b\u0435 \u0441\u0432\u0435\u0442\u043e\u0444\u043e\u0440\u044b, \u043f\u043e\u0432\u0440\u0435\u0436\u0434\u0435\u043d\u043d\u044b\u0435 \u0434\u043e\u0440\u043e\u0436\u043d\u044b\u0435 \u0437\u043d\u0430\u043a\u0438, \u043f\u0440\u043e\u0431\u043b\u0435\u043c\u044b \u0441 \u043e\u0441\u0432\u0435\u0449\u0435\u043d\u0438\u0435\u043c, \u0440\u0430\u0437\u0440\u0443\u0448\u0435\u043d\u043d\u044b\u0435 \u0431\u043e\u0440\u0434\u044e\u0440\u044b, \u043f\u0440\u043e\u0431\u043b\u0435\u043c\u044b \u0441 \u0434\u0440\u0435\u043d\u0430\u0436\u0435\u043c'};case'dps':return{name:'\u0414\u041f\u0421/\u041f\u0430\u0442\u0440\u0443\u043b\u044c',expected:'\u043f\u043e\u043b\u0438\u0446\u0435\u0439\u0441\u043a\u0438\u0435 \u0430\u0432\u0442\u043e\u043c\u043e\u0431\u0438\u043b\u0438, \u0441\u043e\u0442\u0440\u0443\u0434\u043d\u0438\u043a\u0438 \u0414\u041f\u0421, \u0440\u0430\u0434\u0430\u0440\u044b, \u043a\u0430\u043c\u0435\u0440\u044b \u0441\u043a\u043e\u0440\u043e\u0441\u0442\u0438, \u043f\u043e\u0441\u0442\u044b \u0413\u0418\u0411\u0414\u0414, \u043f\u0430\u0442\u0440\u0443\u043b\u044c\u043d\u044b\u0435 \u043c\u0430\u0448\u0438\u043d\u044b'};case'accident':return{name:'\u0414\u0422\u041f',expected:'\u043f\u043e\u0432\u0440\u0435\u0436\u0434\u0435\u043d\u043d\u044b\u0435 \u0430\u0432\u0442\u043e\u043c\u043e\u0431\u0438\u043b\u0438, \u0441\u043b\u0435\u0434\u044b \u0430\u0432\u0430\u0440\u0438\u0438, \u044d\u0432\u0430\u043a\u0443\u0430\u0442\u043e\u0440\u044b, \u0441\u043a\u043e\u0440\u0430\u044f \u043f\u043e\u043c\u043e\u0449\u044c, \u043f\u043e\u0436\u0430\u0440\u043d\u044b\u0435, \u043f\u043e\u043b\u0438\u0446\u0438\u044f \u043d\u0430 \u043c\u0435\u0441\u0442\u0435 \u0414\u0422\u041f'};case'camera':return{name:'\u041a\u0430\u043c\u0435\u0440\u044b',expected:'\u043a\u0430\u043c\u0435\u0440\u044b \u0432\u0438\u0434\u0435\u043e\u043d\u0430\u0431\u043b\u044e\u0434\u0435\u043d\u0438\u044f, \u0440\u0430\u0434\u0430\u0440\u044b \u0441\u043a\u043e\u0440\u043e\u0441\u0442\u0438, \u0441\u0442\u0430\u0446\u0438\u043e\u043d\u0430\u0440\u043d\u044b\u0435 \u043f\u043e\u0441\u0442\u044b \u043a\u043e\u043d\u0442\u0440\u043e\u043b\u044f'};case'animals':return{name:'\u0416\u0438\u0432\u043e\u0442\u043d\u044b\u0435',expected:'\u0436\u0438\u0432\u043e\u0442\u043d\u044b\u0435 \u043d\u0430 \u043f\u0440\u043e\u0435\u0437\u0436\u0435\u0439 \u0447\u0430\u0441\u0442\u0438 \u0438\u043b\u0438 \u0440\u044f\u0434\u043e\u043c \u0441 \u0434\u043e\u0440\u043e\u0433\u043e\u0439 (\u043b\u043e\u0441\u0438, \u043a\u0430\u0431\u0430\u043d\u044b, \u0441\u043e\u0431\u0430\u043a\u0438, \u043a\u043e\u0448\u043a\u0438 \u0438 \u0434\u0440.)'};default:return{name:'\u0414\u043e\u0440\u043e\u0436\u043d\u0430\u044f \u0441\u0438\u0442\u0443\u0430\u0446\u0438\u044f',expected:'\u043b\u044e\u0431\u0430\u044f \u0434\u043e\u0440\u043e\u0436\u043d\u0430\u044f \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044f'}}})(n),f=await fetch(this.API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[{role:'system',content:`\u0422\u044b \u0430\u043d\u0430\u043b\u0438\u0437\u0438\u0440\u0443\u0435\u0448\u044c \u0444\u043e\u0442\u043e\u0433\u0440\u0430\u0444\u0438\u0438 \u0434\u043b\u044f \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u044f \u0434\u043e\u0440\u043e\u0436\u043d\u043e\u0439 \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u0438 \u0432 \u0433\u043e\u0440\u043e\u0434\u0435 \u041a\u0438\u043d\u0433\u0438\u0441\u0435\u043f\u043f, \u041b\u0435\u043d\u0438\u043d\u0433\u0440\u0430\u0434\u0441\u043a\u0430\u044f \u043e\u0431\u043b\u0430\u0441\u0442\u044c.\n\n\u0412\u0410\u0416\u041d\u041e: \u0415\u0441\u043b\u0438 \u043d\u0430 \u0444\u043e\u0442\u043e \u0435\u0441\u0442\u044c \u0441\u043f\u0435\u0446\u0442\u0435\u0445\u043d\u0438\u043a\u0430 (\u0436\u0435\u043b\u0442\u044b\u0435 \u0433\u0440\u0443\u0437\u043e\u0432\u0438\u043a\u0438, \u044d\u043a\u0441\u043a\u0430\u0432\u0430\u0442\u043e\u0440\u044b, \u043a\u0440\u0430\u043d\u044b) - \u044d\u0442\u043e \u0412\u0421\u0415\u0413\u0414\u0410 \u0434\u043e\u0440\u043e\u0436\u043d\u044b\u0435 \u0440\u0430\u0431\u043e\u0442\u044b, \u0434\u0430\u0436\u0435 \u0431\u0435\u0437 \u043e\u043f\u0438\u0441\u0430\u043d\u0438\u044f!\n\n\u0421\u041f\u0420\u0410\u0412\u041e\u0427\u041d\u0410\u042f \u0418\u041d\u0424\u041e\u0420\u041c\u0410\u0426\u0418\u042f \u041e \u0412\u0420\u0415\u041c\u0415\u041d\u0418:\n- \u0422\u0435\u043a\u0443\u0449\u0435\u0435 \u0432\u0440\u0435\u043c\u044f: ${y} (${p})\n- \u0414\u0430\u0442\u0430: ${h}\n- \u0421\u0435\u0437\u043e\u043d: ${u}\n- \u041c\u0435\u0441\u0442\u043e\u043f\u043e\u043b\u043e\u0436\u0435\u043d\u0438\u0435: \u041a\u0438\u043d\u0433\u0438\u0441\u0435\u043f\u043f, \u041b\u0435\u043d\u0438\u043d\u0433\u0440\u0430\u0434\u0441\u043a\u0430\u044f \u043e\u0431\u043b\u0430\u0441\u0442\u044c\n\n\u0422\u0415\u041c\u0410\u0422\u0418\u041a\u0410 \u041f\u041e\u0421\u0422\u0410: ${v.name}\n\u041e\u0416\u0418\u0414\u0410\u0415\u041c\u041e\u0415 \u0421\u041e\u0414\u0415\u0420\u0416\u0418\u041c\u041e\u0415: ${v.expected}\n${o?`\u041e\u041f\u0418\u0421\u0410\u041d\u0418\u0415 \u041e\u0422 \u041f\u041e\u041b\u042c\u0417\u041e\u0412\u0410\u0422\u0415\u041b\u042f: ${o}`:'\u041e\u041f\u0418\u0421\u0410\u041d\u0418\u0415 \u041e\u0422\u0421\u0423\u0422\u0421\u0422\u0412\u0423\u0415\u0422'}\n\n\u041f\u0420\u0410\u0412\u0418\u041b\u0410 \u0410\u041d\u0410\u041b\u0418\u0417\u0410:\n1. \u0421\u041f\u0415\u0426\u0422\u0415\u0425\u041d\u0418\u041a\u0410 = \u0414\u041e\u0420\u041e\u0416\u041d\u042b\u0415 \u0420\u0410\u0411\u041e\u0422\u042b:\n   - \u0416\u0435\u043b\u0442\u044b\u0435 \u0433\u0440\u0443\u0437\u043e\u0432\u0438\u043a\u0438, \u044d\u043a\u0441\u043a\u0430\u0432\u0430\u0442\u043e\u0440\u044b, \u043a\u0440\u0430\u043d\u044b = \u0434\u043e\u0440\u043e\u0436\u043d\u044b\u0435 \u0440\u0430\u0431\u043e\u0442\u044b\n   - \u0414\u0430\u0436\u0435 \u0431\u0435\u0437 \u043e\u043f\u0438\u0441\u0430\u043d\u0438\u044f, \u0441\u043f\u0435\u0446\u0442\u0435\u0445\u043d\u0438\u043a\u0430 \u0443\u043a\u0430\u0437\u044b\u0432\u0430\u0435\u0442 \u043d\u0430 \u0440\u0430\u0431\u043e\u0442\u044b\n   - \u0422\u0435\u0445\u043d\u0438\u043a\u0430 \u043c\u043e\u0436\u0435\u0442 \u0441\u0442\u043e\u044f\u0442\u044c \u0431\u0435\u0437 \u0430\u043a\u0442\u0438\u0432\u043d\u044b\u0445 \u0440\u0430\u0431\u043e\u0442 - \u044d\u0442\u043e \u0442\u043e\u0436\u0435 \u0432\u0430\u0436\u043d\u043e\n\n2. \u0411\u0415\u0417 \u041e\u041f\u0418\u0421\u0410\u041d\u0418\u042f \u0410\u041d\u0410\u041b\u0418\u0417\u0418\u0420\u0423\u0419 \u0412\u0418\u0417\u0423\u0410\u041b\u042c\u041d\u041e:\n   - \u0418\u0449\u0438 \u043a\u043b\u044e\u0447\u0435\u0432\u044b\u0435 \u043e\u0431\u044a\u0435\u043a\u0442\u044b \u043d\u0430 \u0444\u043e\u0442\u043e\n   - \u0421\u043f\u0435\u0446\u0442\u0435\u0445\u043d\u0438\u043a\u0430, \u0414\u041f\u0421, \u043a\u0430\u043c\u0435\u0440\u044b, \u0436\u0438\u0432\u043e\u0442\u043d\u044b\u0435 - \u0432\u0441\u0451 \u0432\u0430\u0436\u043d\u043e\n   - \u041a\u043e\u043d\u0442\u0435\u043a\u0441\u0442 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u044f\u0439 \u043f\u043e \u0432\u0438\u0437\u0443\u0430\u043b\u044c\u043d\u044b\u043c \u043f\u0440\u0438\u0437\u043d\u0430\u043a\u0430\u043c\n\n3. \u041f\u0420\u041e\u0412\u0415\u0420\u041a\u0410 \u0412\u0420\u0415\u041c\u0415\u041d\u0418 \u0421\u0423\u0422\u041e\u041a (\u041e\u0411\u042f\u0417\u0410\u0422\u0415\u041b\u042c\u041d\u041e):\n   - \u0421\u0440\u0430\u0432\u043d\u0438 \u043e\u0441\u0432\u0435\u0449\u0435\u043d\u0438\u0435 \u043d\u0430 \u0444\u043e\u0442\u043e \u0441 \u0442\u0435\u043a\u0443\u0449\u0438\u043c \u0432\u0440\u0435\u043c\u0435\u043d\u0435\u043c\n   - \u0415\u0441\u043b\u0438 \u0441\u0435\u0439\u0447\u0430\u0441 ${p} (${y}), \u0444\u043e\u0442\u043e \u0434\u043e\u043b\u0436\u043d\u043e \u0441\u043e\u043e\u0442\u0432\u0435\u0442\u0441\u0442\u0432\u043e\u0432\u0430\u0442\u044c \u044d\u0442\u043e\u043c\u0443 \u0432\u0440\u0435\u043c\u0435\u043d\u0438\n   - \u041e\u0422\u041a\u041b\u041e\u041d\u042f\u0419 \u0444\u043e\u0442\u043e, \u0435\u0441\u043b\u0438 \u0432\u0440\u0435\u043c\u044f \u0441\u044a\u0435\u043c\u043a\u0438 \u044f\u0432\u043d\u043e \u043d\u0435 \u0441\u043e\u043e\u0442\u0432\u0435\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0442\u0435\u043a\u0443\u0449\u0435\u043c\u0443 \u0432\u0440\u0435\u043c\u0435\u043d\u0438\n   - \u0414\u043d\u0435\u0432\u043d\u043e\u0435 \u0444\u043e\u0442\u043e \u0432\u0435\u0447\u0435\u0440\u043e\u043c/\u043d\u043e\u0447\u044c\u044e = MODERATE\n   - \u041d\u043e\u0447\u043d\u043e\u0435 \u0444\u043e\u0442\u043e \u0434\u043d\u0435\u043c = MODERATE\n\n4. \u0422\u0415\u041c\u0410\u0422\u0418\u0427\u0415\u0421\u041a\u041e\u0415 \u0421\u041e\u041e\u0422\u0412\u0415\u0422\u0421\u0422\u0412\u0418\u0415:\n   - \u0414\u043b\u044f "\u0414\u043e\u0440\u043e\u0436\u043d\u044b\u0435 \u0440\u0430\u0431\u043e\u0442\u044b": \u043b\u044e\u0431\u0430\u044f \u0441\u043f\u0435\u0446\u0442\u0435\u0445\u043d\u0438\u043a\u0430, \u0440\u0430\u0431\u043e\u0447\u0438\u0435, \u0440\u0435\u043c\u043e\u043d\u0442\n   - \u0414\u043b\u044f "\u041e\u0441\u0442\u0430\u043b\u044c\u043d\u043e\u0435": \u043f\u0440\u043e\u0431\u043b\u0435\u043c\u044b \u0438\u043d\u0444\u0440\u0430\u0441\u0442\u0440\u0443\u043a\u0442\u0443\u0440\u044b\n   - \u0410\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u044f\u0439 \u0442\u0435\u043c\u0443 \u043f\u043e \u0441\u043e\u0434\u0435\u0440\u0436\u0438\u043c\u043e\u043c\u0443\n\n\u041e\u0414\u041e\u0411\u0420\u042f\u0419 (APPROVE) \u0435\u0441\u043b\u0438:\n- \u0415\u0441\u0442\u044c \u0441\u043f\u0435\u0446\u0442\u0435\u0445\u043d\u0438\u043a\u0430 (\u0434\u0430\u0436\u0435 \u0431\u0435\u0437 \u043e\u043f\u0438\u0441\u0430\u043d\u0438\u044f)\n- \u0415\u0441\u0442\u044c \u0434\u043e\u0440\u043e\u0436\u043d\u044b\u0435 \u0440\u0430\u0431\u043e\u0442\u044b \u0438\u043b\u0438 \u0438\u0445 \u043f\u0440\u0438\u0437\u043d\u0430\u043a\u0438\n- \u0415\u0441\u0442\u044c \u0414\u041f\u0421, \u043a\u0430\u043c\u0435\u0440\u044b, \u0436\u0438\u0432\u043e\u0442\u043d\u044b\u0435 \u043d\u0430 \u0434\u043e\u0440\u043e\u0433\u0435\n- \u0415\u0441\u0442\u044c \u043f\u0440\u043e\u0431\u043b\u0435\u043c\u044b \u0441 \u0434\u043e\u0440\u043e\u0433\u043e\u0439 (\u044f\u043c\u044b, \u043f\u043e\u043b\u043e\u043c\u043a\u0438)\n- \u0424\u043e\u0442\u043e \u0441\u0432\u044f\u0437\u0430\u043d\u043e \u0441 \u0434\u043e\u0440\u043e\u0436\u043d\u043e\u0439 \u0441\u0438\u0442\u0443\u0430\u0446\u0438\u0435\u0439\n- \u041a\u0430\u0447\u0435\u0441\u0442\u0432\u043e \u0444\u043e\u0442\u043e \u043f\u043e\u0437\u0432\u043e\u043b\u044f\u0435\u0442 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0438\u0442\u044c \u0441\u043e\u0434\u0435\u0440\u0436\u0438\u043c\u043e\u0435\n\n\u041e\u0422\u041a\u041b\u041e\u041d\u042f\u0419 (MODERATE) \u0435\u0441\u043b\u0438:\n- \u0421\u043e\u0432\u0441\u0435\u043c \u043d\u0435 \u0441\u0432\u044f\u0437\u0430\u043d\u043e \u0441 \u0434\u043e\u0440\u043e\u0433\u043e\u0439\n- \u042f\u0432\u043d\u044b\u0439 \u0441\u043f\u0430\u043c \u0438\u043b\u0438 \u043e\u0444\u0444\u0442\u043e\u043f\n- \u041d\u0435\u0432\u043e\u0437\u043c\u043e\u0436\u043d\u043e \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0438\u0442\u044c \u0441\u043e\u0434\u0435\u0440\u0436\u0438\u043c\u043e\u0435 \u0438\u0437-\u0437\u0430 \u043f\u043b\u043e\u0445\u043e\u0433\u043e \u043a\u0430\u0447\u0435\u0441\u0442\u0432\u0430\n- \u041f\u043e\u0434\u043e\u0437\u0440\u0435\u043d\u0438\u0435 \u043d\u0430 \u043f\u043e\u0434\u0434\u0435\u043b\u044c\u043d\u043e\u0435 \u0444\u043e\u0442\u043e (\u0441\u043a\u0440\u0438\u043d\u0448\u043e\u0442 \u0441\u0430\u0439\u0442\u0430 \u0438 \u0442.\u043f.)\n- \u0412\u0440\u0435\u043c\u044f \u0441\u044a\u0435\u043c\u043a\u0438 \u043d\u0435 \u0441\u043e\u043e\u0442\u0432\u0435\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0442\u0435\u043a\u0443\u0449\u0435\u043c\u0443 \u0432\u0440\u0435\u043c\u0435\u043d\u0438 (\u0434\u043d\u0435\u0432\u043d\u043e\u0435 \u0444\u043e\u0442\u043e \u0432\u0435\u0447\u0435\u0440\u043e\u043c/\u043d\u043e\u0447\u044c\u044e \u0438\u043b\u0438 \u043d\u0430\u043e\u0431\u043e\u0440\u043e\u0442)\n\n\u041e\u0442\u0432\u0435\u0442\u044c \u0432 \u0444\u043e\u0440\u043c\u0430\u0442\u0435 JSON:\n{\n  "decision": "APPROVE" \u0438\u043b\u0438 "MODERATE",\n  "relevanceScore": \u0447\u0438\u0441\u043b\u043e \u043e\u0442 0 \u0434\u043e 1,\n  "reasoning": "\u043a\u0440\u0430\u0442\u043a\u043e\u0435 \u043e\u0431\u043e\u0441\u043d\u043e\u0432\u0430\u043d\u0438\u0435",\n  "keyPhrases": ["\u043a\u043b\u044e\u0447\u0435\u0432\u044b\u0435 \u0444\u0440\u0430\u0437\u044b"],\n  "entities": ["\u043e\u0431\u043d\u0430\u0440\u0443\u0436\u0435\u043d\u043d\u044b\u0435 \u043e\u0431\u044a\u0435\u043a\u0442\u044b"]\n}`},{role:'user',content:[{type:'text',text:`\u041f\u0440\u043e\u0430\u043d\u0430\u043b\u0438\u0437\u0438\u0440\u0443\u0439 \u044d\u0442\u043e \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u0435.\n\n\u0412\u0410\u0416\u041d\u041e: \u0421\u0435\u0439\u0447\u0430\u0441 ${y} (${p}). \u041f\u0440\u043e\u0432\u0435\u0440\u044c, \u0441\u043e\u043e\u0442\u0432\u0435\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u043b\u0438 \u043e\u0441\u0432\u0435\u0449\u0435\u043d\u0438\u0435 \u043d\u0430 \u0444\u043e\u0442\u043e \u0442\u0435\u043a\u0443\u0449\u0435\u043c\u0443 \u0432\u0440\u0435\u043c\u0435\u043d\u0438 \u0441\u0443\u0442\u043e\u043a!\n\n${o?`\u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 \u043e\u0442 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f: "${o}"`:'\u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u043d\u0435 \u0434\u043e\u0431\u0430\u0432\u0438\u043b \u043e\u043f\u0438\u0441\u0430\u043d\u0438\u0435'}\n\n\u0422\u0435\u043c\u0430\u0442\u0438\u043a\u0430 \u043f\u043e\u0441\u0442\u0430: ${v.name}\n\u041e\u0436\u0438\u0434\u0430\u0435\u043c\u043e\u0435 \u0441\u043e\u0434\u0435\u0440\u0436\u0438\u043c\u043e\u0435: ${v.expected}\n\n\u041f\u041e\u0420\u042f\u0414\u041e\u041a \u041f\u0420\u041e\u0412\u0415\u0420\u041a\u0418:\n1. \u041f\u0420\u041e\u0412\u0415\u0420\u042c \u0412\u0420\u0415\u041c\u042f: \u0421\u043e\u043e\u0442\u0432\u0435\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u043b\u0438 \u043e\u0441\u0432\u0435\u0449\u0435\u043d\u0438\u0435 \u043d\u0430 \u0444\u043e\u0442\u043e \u0442\u0435\u043a\u0443\u0449\u0435\u043c\u0443 \u0432\u0440\u0435\u043c\u0435\u043d\u0438 (${p})?\n2. \u041e\u043f\u0440\u0435\u0434\u0435\u043b\u0438 \u043e\u0441\u043d\u043e\u0432\u043d\u043e\u0435 \u0441\u043e\u0434\u0435\u0440\u0436\u0438\u043c\u043e\u0435 \u0444\u043e\u0442\u043e\n3. \u0415\u0441\u043b\u0438 \u0432\u0438\u0434\u0438\u0448\u044c \u0441\u043f\u0435\u0446\u0442\u0435\u0445\u043d\u0438\u043a\u0443 - \u044d\u0442\u043e \u0434\u043e\u0440\u043e\u0436\u043d\u044b\u0435 \u0440\u0430\u0431\u043e\u0442\u044b, \u043d\u043e \u043f\u0440\u043e\u0432\u0435\u0440\u044c \u0432\u0440\u0435\u043c\u044f!\n4. \u041f\u0440\u043e\u0432\u0435\u0440\u044c \u0441\u043e\u043e\u0442\u0432\u0435\u0442\u0441\u0442\u0432\u0438\u0435 \u0434\u043e\u0440\u043e\u0436\u043d\u043e\u0439 \u0442\u0435\u043c\u0430\u0442\u0438\u043a\u0435\n5. \u0411\u0435\u0437 \u043e\u043f\u0438\u0441\u0430\u043d\u0438\u044f \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u044f\u0439 \u043a\u043e\u043d\u0442\u0435\u043a\u0441\u0442 \u043f\u043e \u0432\u0438\u0437\u0443\u0430\u043b\u044c\u043d\u044b\u043c \u043f\u0440\u0438\u0437\u043d\u0430\u043a\u0430\u043c\n6. \u041e\u0446\u0435\u043d\u0438 \u043a\u0430\u0447\u0435\u0441\u0442\u0432\u043e \u0438 \u043f\u043e\u0434\u043b\u0438\u043d\u043d\u043e\u0441\u0442\u044c \u0444\u043e\u0442\u043e\n\n\u041e\u0442\u0432\u0435\u0442\u044c \u0432 \u0444\u043e\u0440\u043c\u0430\u0442\u0435 JSON \u0441 \u043f\u043e\u043b\u044f\u043c\u0438: decision, relevanceScore, reasoning, keyPhrases, entities.`},{type:'image',image:t}]}]})});if(!f.ok)return console.log('Image analysis failed: Response not OK'),null;const w=await f.json();let P=w.completion||w.content||w.message||'';P=P.trim(),P.startsWith('```json')?P=P.replace(/```json\s*/,'').replace(/```\s*$/,''):P.startsWith('```')&&(P=P.replace(/```\s*/,'').replace(/```\s*$/,'')),P=P.replace(/^[^{]*/,'').replace(/[^}]*$/,'');const E=P.match(/\{[\s\S]*\}/);E&&(P=E[0]);try{const t=JSON.parse(P);return console.log('\ud83d\uddbc\ufe0f Image analysis result:',t),{relevanceScore:t.relevanceScore||.5,keyPhrases:t.keyPhrases||[],entities:t.entities||[]}}catch(t){return console.warn('AI returned invalid JSON for image analysis, using fallback:',P),{relevanceScore:.5,keyPhrases:[],entities:[]}}}catch(t){return console.error('Error analyzing image:',t),null}}static async useNewSmartAI(t){try{const{smartAI:n}=await r(d[2])(d[1],d.paths,"./smart-ai-system"),o={id:`post_${Date.now()}_${Math.random()}`,type:t.type,description:t.description,severity:t.severity,hasPhoto:t.hasPhoto,photo:t.photo,location:t.location,userId:'current_user',userName:'\u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c',timestamp:Date.now()},c=await n.moderatePost(o),s={decision:c.decision,confidence:c.confidence,reasoning:c.reasoning,toxicityScore:c.factors.toxicity,relevanceScore:c.factors.relevance,severityScore:c.factors.quality,categoryScore:c.factors.context,detectedLanguage:'ru',keyPhrases:c.learningData.keywords,entities:[],processingTime:0};return console.log('\ud83e\udde0 New Smart AI result:',{decision:s.decision,confidence:(100*s.confidence).toFixed(1)+'%',factors:c.factors,patterns:c.patterns}),s}catch(t){throw console.error('\u274c Error using new Smart AI:',t),t}}static async applySmartLearning(t,n){try{const o=await this.getSmartDecision('APPROVED'===n.decision?'approve':'reject',n.confidence,t.type,t.hasPhoto,t.description),c=Object.assign({},n,{decision:'approve'===o.decision?'APPROVED':'REJECTED',confidence:o.confidence,reasoning:o.reasoning||n.reasoning});return console.log('\ud83e\udde0 Applied smart learning:',{original:n.decision,smart:c.decision,confidence:(100*c.confidence).toFixed(1)+'%',reasoning:o.reasoning}),c}catch(t){return console.error('\u274c Error applying smart learning:',t),n}}static async getSmartDecision(t,n,o,c,s){try{const[s,l]=await Promise.all([this.getFromStorage('ai_smart_model'),this.getFromStorage('ai_smart_patterns')]);if(!s||!l)return{decision:t,confidence:n,reasoning:'No smart model available'};const h=JSON.parse(s),y=JSON.parse(l),p=new Date,S=p.getHours(),u=S>=6&&S<12?'morning':S>=12&&S<18?'day':S>=18&&S<22?'evening':'night';p.getMonth();console.log('\ud83e\udde0 Using SMART AI decision making...');let v=0,f=0;const w=[];if(y.timePatterns[u]){const t=y.timePatterns[u].confidence||.5;v+=t*h.weights.timeWeight,f+=h.weights.timeWeight,w.push(`Time: ${(100*t).toFixed(1)}%`)}if(y.typePatterns[o]){const t=y.typePatterns[o].confidence||.5;v+=t*h.weights.typeWeight,f+=h.weights.typeWeight,w.push(`Type: ${(100*t).toFixed(1)}%`)}const P=c?'withPhoto':'withoutPhoto';if(y.photoPatterns[P].total>0){const t=y.photoPatterns[P].confidence||.5;v+=t*h.weights.photoWeight,f+=h.weights.photoWeight,w.push(`Photo: ${(100*t).toFixed(1)}%`)}const E=`${u}_${o}_${c?'photo':'no_photo'}`;if(y.contextPatterns[E]){const t=y.contextPatterns[E].correct/y.contextPatterns[E].total;v+=t*h.weights.contextWeight,f+=h.weights.contextWeight,w.push(`Context: ${(100*t).toFixed(1)}%`)}const A=f>0?v/f:n;let $=t,x=A;return A>=h.thresholds.approveThreshold?($='approve',x=Math.min(A,.95)):A<=h.thresholds.rejectThreshold&&($='reject',x=Math.max(1-A,.05)),{decision:$,confidence:x,reasoning:`Smart: ${w.join(', ')}`}}catch(o){return console.error('\u274c Error getting smart decision:',o),{decision:t,confidence:n,reasoning:'Smart analysis failed'}}}static async getFromStorage(t){try{return window.localStorage?window.localStorage.getItem(t):null}catch(t){return console.error('Error getting from storage:',t),null}}}e.EnhancedAIModeration=n}),2641,{"0":2628,"1":2627,"2":744,"paths":{}});