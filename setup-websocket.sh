#!/bin/bash

# üîå –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ WebSocket —Å–µ—Ä–≤–µ—Ä–∞
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: bash setup-websocket.sh

set -e

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É WebSocket —Å–µ—Ä–≤–µ—Ä–∞..."

# 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
if [ ! -f "docker-compose.yml" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: docker-compose.yml –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "üìÅ –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å–Ω–æ–≤–∞"
    exit 1
fi

echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞"

# 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç –ª–∏ –ø–æ—Ä—Ç 8080
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç 8080..."
if netstat -tuln 2>/dev/null | grep -q ":8080 "; then
    echo "‚úÖ –ü–æ—Ä—Ç 8080 —É–∂–µ –æ—Ç–∫—Ä—ã—Ç"
else
    echo "üîì –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç 8080..."
    
    # –ü—Ä–æ–±—É–µ–º ufw
    if command -v ufw &> /dev/null; then
        ufw allow 8080/tcp
        ufw allow 8081/tcp
        ufw reload
        echo "‚úÖ –ü–æ—Ä—Ç 8080 –æ—Ç–∫—Ä—ã—Ç —á–µ—Ä–µ–∑ ufw"
    else
        # –ü—Ä–æ–±—É–µ–º iptables
        if command -v iptables &> /dev/null; then
            iptables -A INPUT -p tcp --dport 8080 -j ACCEPT
            iptables -A INPUT -p tcp --dport 8081 -j ACCEPT
            echo "‚úÖ –ü–æ—Ä—Ç 8080 –æ—Ç–∫—Ä—ã—Ç —á–µ—Ä–µ–∑ iptables"
        else
            echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
            echo "üìù –û—Ç–∫—Ä–æ–π—Ç–µ –ø–æ—Ä—Ç 8080 –≤—Ä—É—á–Ω—É—é –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö firewall"
        fi
    fi
fi

# 3. –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
echo "üì• –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ Git..."
git pull origin main

# 4. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker-compose down

# 5. –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑
echo "üî® –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑..."
docker-compose build --no-cache

# 6. –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker-compose up -d

# 7. –ñ–¥–µ–º 10 —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å
echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
sleep 10

# 8. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker-compose ps

# 9. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç—ã
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ—Ä—Ç—ã..."
netstat -tuln | grep -E '8080|8081' || ss -tuln | grep -E '8080|8081'

# 10. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ WebSocket
echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ WebSocket —Å–µ—Ä–≤–µ—Ä–∞:"
docker-compose logs | grep -E 'WebSocket|8080' | tail -20

# 11. –ü—Ä–æ–≤–µ—Ä—è–µ–º health check
echo "üè• –ü—Ä–æ–≤–µ—Ä—è–µ–º health check..."
sleep 5
curl -s http://localhost:8081/api/health || echo "‚ö†Ô∏è Health check –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"

# 12. –ü—Ä–æ–≤–µ—Ä—è–µ–º WebSocket —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º WebSocket —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É..."
curl -s http://localhost:8080/api/ws/stats || echo "‚ö†Ô∏è WebSocket –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"

echo ""
echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: docker-compose logs -f"
echo "2. –û—Ç–∫—Ä–æ–π—Ç–µ https://24dps.ru/ –≤ –±—Ä–∞—É–∑–µ—Ä–µ"
echo "3. –ó–∞–π–¥–∏—Ç–µ –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏"
echo "4. –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: '‚ö†Ô∏è WebSocket disabled - server not configured'"
echo ""
echo "üîß –ï—Å–ª–∏ WebSocket —Ä–∞–±–æ—Ç–∞–µ—Ç, –≤–∫–ª—é—á–∏—Ç–µ –µ–≥–æ –≤ –∫–æ–¥–µ:"
echo "   - hooks/useRealTimeUpdates.tsx: enabled: true"
echo "   - hooks/useNotifications.tsx: —É–¥–∞–ª–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏ —Å 'return'"
echo "   - git commit -m 'enable websocket'"
echo "   - git push origin main"
echo ""
echo "üÜò –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
echo "   docker-compose logs -f | grep -E 'WebSocket|8080'"

